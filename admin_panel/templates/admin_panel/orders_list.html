{% extends 'admin_panel/base.html' %}

{% block title %}–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è - –ê–¥–º—ñ–Ω –ü–∞–Ω–µ–ª—å{% endblock %}
{% block page_title %}–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è{% endblock %}

{% block content %}
<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card border-primary text-center">
            <i class="fas fa-shopping-cart text-primary"></i>
            <h6 class="text-primary">–í—Å—å–æ–≥–æ</h6>
            <h4>{{ stats.total }}</h4>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card border-warning text-center">
            <i class="fas fa-plus-circle text-warning"></i>
            <h6 class="text-warning">–ù–æ–≤—ñ</h6>
            <h4>{{ stats.new }}</h4>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card border-info text-center">
            <i class="fas fa-clock text-info"></i>
            <h6 class="text-info">–í –æ–±—Ä–æ–±—Ü—ñ</h6>
            <h4>{{ stats.processing }}</h4>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card border-success text-center">
            <i class="fas fa-check-circle text-success"></i>
            <h6 class="text-success">–í–∏–∫–æ–Ω–∞–Ω–æ</h6>
            <h4>{{ stats.completed }}</h4>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="stat-card border-danger text-center">
            <i class="fas fa-times-circle text-danger"></i>
            <h6 class="text-danger">–°–∫–∞—Å–æ–≤–∞–Ω–æ</h6>
            <h4>{{ stats.cancelled }}</h4>
        </div>
    </div>
</div>

<!-- –§—ñ–ª—å—Ç—Ä–∏ -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-filter me-2"></i>
            –§—ñ–ª—å—Ç—Ä–∏
        </h5>
    </div>
    <div class="card-body">
        <div class="btn-group" role="group">
            <a href="?status=all" class="btn {% if current_filter == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                –í—Å—ñ
            </a>
            <a href="?status=–Ω–æ–≤–µ" class="btn {% if current_filter == '–Ω–æ–≤–µ' %}btn-warning{% else %}btn-outline-warning{% endif %}">
                –ù–æ–≤—ñ
            </a>
            <a href="?status=–≤ –æ–±—Ä–æ–±—Ü—ñ" class="btn {% if current_filter == '–≤ –æ–±—Ä–æ–±—Ü—ñ' %}btn-info{% else %}btn-outline-info{% endif %}">
                –í –æ–±—Ä–æ–±—Ü—ñ
            </a>
            <a href="?status=–≤–∏–∫–æ–Ω–∞–Ω–æ" class="btn {% if current_filter == '–≤–∏–∫–æ–Ω–∞–Ω–æ' %}btn-success{% else %}btn-outline-success{% endif %}">
                –í–∏–∫–æ–Ω–∞–Ω–æ
            </a>
            <a href="?status=—Å–∫–∞—Å–æ–≤–∞–Ω–æ" class="btn {% if current_filter == '—Å–∫–∞—Å–æ–≤–∞–Ω–æ' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                –°–∫–∞—Å–æ–≤–∞–Ω–æ
            </a>
        </div>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω—å -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-shopping-cart me-2"></i>
            –°–ø–∏—Å–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω—å ({{ orders|length }})
        </h5>
    </div>
    <div class="card-body">
        {% if orders %}
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>‚Ññ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</th>
                            <th>–ö–ª—ñ—î–Ω—Ç</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–°—É–º–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î—ñ—ó</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>
                                <strong>{{ order.order_number }}</strong>
                            </td>
                            <td>
                                <div>
                                    <strong>{{ order.customer_name }}</strong><br>
                                    <small class="text-muted">{{ order.customer_phone }}</small>
                                </div>
                            </td>
                            <td>
                                <div>
                                    {{ order.order_date|slice:":10" }}<br>
                                    <small class="text-muted">{{ order.order_date|slice:"11:16" }}</small>
                                </div>
                            </td>
                            <td>
                                <strong>{{ order.total_amount }} {{ order.currency }}</strong>
                            </td>
                            <td>
                                {% if order.status == '–Ω–æ–≤–µ' %}
                                    <span class="badge bg-warning">{{ order.status }}</span>
                                {% elif order.status == '–≤ –æ–±—Ä–æ–±—Ü—ñ' %}
                                    <span class="badge bg-info">{{ order.status }}</span>
                                {% elif order.status == '–≤–∏–∫–æ–Ω–∞–Ω–æ' %}
                                    <span class="badge bg-success">{{ order.status }}</span>
                                {% elif order.status == '—Å–∫–∞—Å–æ–≤–∞–Ω–æ' %}
                                    <span class="badge bg-danger">{{ order.status }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ order.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'admin_panel:order_detail' order.id %}" class="btn btn-sm btn-primary" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –¥–µ—Ç–∞–ª—ñ">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button class="btn btn-sm btn-warning" onclick="changeOrderStatus('{{ order.id }}', '{{ order.status }}', '{{ order.order_number }}')" title="–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">–ó–∞–º–æ–≤–ª–µ–Ω—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</h5>
                <p class="text-muted">–ó –æ–±—Ä–∞–Ω–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏ –∑–∞–º–æ–≤–ª–µ–Ω—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
<div class="modal fade" id="changeStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>
                    –ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="" id="changeStatusForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è:</label>
                        <input type="text" class="form-control" id="orderNumber" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å:</label>
                        <input type="text" class="form-control" id="currentStatus" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">–ù–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å:</label>
                        <select class="form-select" name="status" id="newStatus" required>
                            <option value="–Ω–æ–≤–µ">üÜï –ù–æ–≤–µ</option>
                            <option value="–≤ –æ–±—Ä–æ–±—Ü—ñ">‚è≥ –í –æ–±—Ä–æ–±—Ü—ñ</option>
                            <option value="–≤–∏–∫–æ–Ω–∞–Ω–æ">‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ</option>
                            <option value="—Å–∫–∞—Å–æ–≤–∞–Ω–æ">‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="statusComment" class="form-label">–ö–æ–º–µ–Ω—Ç–∞—Ä (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ):</label>
                        <textarea class="form-control" name="comment" id="statusComment" rows="3" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save me-1"></i>
                        –ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function changeOrderStatus(orderId, currentStatus, orderNumber) {
    try {
        document.getElementById('orderNumber').value = orderNumber;
        document.getElementById('currentStatus').value = currentStatus;
        document.getElementById('newStatus').value = currentStatus;
        document.getElementById('changeStatusForm').action = `/admin-panel/orders/${orderId}/status/`;
        
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –±–µ–∑–ø–µ—á–Ω–∏–π –º–µ—Ç–æ–¥ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
        openModal('changeStatusModal')
            .then(() => {
                console.log('–ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É –≤—ñ–¥–∫—Ä–∏—Ç–æ —É—Å–ø—ñ—à–Ω–æ');
            })
            .catch((error) => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ñ–æ—Ä–º–∏ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É');
            });
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ñ–æ—Ä–º–∏ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É');
    }
}
</script>
{% endblock %}
